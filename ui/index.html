<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Coop Door</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#0b0b0c">
  <link rel="manifest" href="./manifest.webmanifest?v=3">
  <link rel="apple-touch-icon" href="./apple-touch-icon.png">
  <style>
    :root {
      --bg:#0b0b0c; --bg-elev:#121316; --card:#0f1013; --border:#22252a;
      --fg:#e6e6e6; --muted:#9aa0a6; --brand:#4e5fff; --ok:#56d364; --warn:#f4bf4f; --bad:#ff7b72;
      --radius:12px; --shadow:0 6px 24px rgba(0,0,0,.35); --speed:.18s;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    header{position:sticky;top:0;z-index:50;padding:14px 18px;border-bottom:1px solid var(--border);
      background:#0d0e11cc;backdrop-filter:saturate(120%) blur(8px)}
    main{max-width:980px;margin:0 auto;padding:18px;display:grid;gap:16px}
    h1{margin:0;font-size:1.6rem;letter-spacing:.3px;color:#c7ccff}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grow{flex:1 1 auto}
    .pill{background:#1b1c20;border:1px solid var(--border);padding:6px 12px;border-radius:999px;font-size:.85rem}
    .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    nav.tabs{display:flex;gap:8px;border-bottom:1px solid var(--border)}
    nav.tabs a{padding:10px 12px;border-radius:10px 10px 0 0;color:var(--fg);text-decoration:none;border:1px solid transparent}
    nav.tabs a.active{border-color:var(--border);border-bottom-color:transparent;background:#15161a}
    .card{background:var(--bg-elev);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
    .title{margin:0 0 10px;font-size:1rem;color:#c7ccff}
    .subtitle{color:var(--muted);font-size:.9rem;margin:.25rem 0 .75rem}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){.grid2{grid-template-columns:1fr}}
    .btn{appearance:none;border:1px solid transparent;cursor:pointer;border-radius:12px;padding:14px 18px;font-weight:700;
      transition:transform var(--speed),background var(--speed),border-color var(--speed),opacity var(--speed);user-select:none}
    .btn.primary{background:var(--brand);color:#fff}
    .btn.neutral{background:#1a1b1f;color:var(--fg);border-color:var(--border)}
    .btn.ghost{background:transparent;border-color:var(--border);color:var(--fg)}
    .btn:disabled{opacity:.55;cursor:default}
    .btn.loading{pointer-events:none;opacity:.85;position:relative}
    .btn.loading::after{content:"";width:18px;height:18px;border-radius:50%;border:2px solid #fff;border-right-color:transparent;position:absolute;right:12px;top:50%;transform:translateY(-50%);animation:spin .7s linear infinite}
    @keyframes spin{to{transform:translateY(-50%) rotate(360deg)}}
    .actions{display:grid;grid-template-columns:repeat(2, minmax(140px,1fr));gap:12px}
    .status-card{background:var(--card);border:1px dashed var(--border);padding:14px;border-radius:12px}
    .kv{display:grid;grid-template-columns:130px 1fr;gap:6px 10px;font-family:ui-monospace, SFMono-Regular, Menlo, monospace}
    .dim{color:var(--muted)}
    .cap-note{font-size:.9rem;color:var(--muted)}
    .caps-disabled .btn[data-pct]{opacity:.6}
    footer.sticky{position:fixed;left:0;right:0;bottom:0;padding:10px;display:flex;justify-content:center;background:transparent}
    .tiny{opacity:.65;font-size:.8rem}
  </style>

</head>
<body>
<header>
  <div class="row">
    <h1 class="grow">Coop Door</h1>
    <span id="apiBadge" class="pill bad">api: down</span>
    <span id="doorBadge" class="pill warn">door: idle</span>
  </div>
</header>

<main>
  <nav class="tabs">
    <a href="#control" id="tab-control" class="active">Control / Status</a>
    <a href="#config" id="tab-config">Config</a>
    <a href="#diag" id="tab-diag">Diagnostics</a>
  </nav>

  <section id="page-control" class="card">
    <h2 class="title">Controls</h2>
    <div id="capWrap" class="cap-note">Enforced cap: <span id="capVal">none</span></div>
    <div id="openGrid" class="actions" style="margin-top:10px">
      <button class="btn primary" data-pct="25" onclick="openTo(25)">Open 25%</button>
      <button class="btn primary" data-pct="50" onclick="openTo(50)">Open 50%</button>
      <button class="btn primary" data-pct="75" onclick="openTo(75)">Open 75%</button>
      <button class="btn primary" data-pct="100" onclick="openTo(100)">Open 100%</button>
      <button id="btnClose" class="btn neutral" onclick="closeDoor()">Close</button>
      <button id="btnStatus" class="btn ghost" onclick="getStatus()">Status</button>
    </div>

    <div class="status-card" style="margin-top:14px">
      <div class="kv">
        <div class="dim">Door</div><div id="sConnected">Unknown</div>
        <div class="dim">Last Action</div><div id="sLast">No actions yet</div>
        <div class="dim">Schedule</div><div id="sSched">â€”</div>
        <div class="dim">Open</div><div id="sOpen">--:--</div>
        <div class="dim">Close</div><div id="sClose">--:--</div>
      </div>
    </div>
  </section>

  <section id="page-config" class="card" style="display:none">
    <h2 class="title">Config</h2>
    <div class="row" style="margin-bottom:6px">
      <label><input type="radio" name="mode" value="fixed" checked> Fixed</label>
      <label><input type="radio" name="mode" value="solar"> Sunrise / Sunset</label>
    </div>

    <div id="fixedBlock" class="grid2">
      <div><label>Open time <input id="fixOpen" type="time" value="07:00"></label></div>
      <div><label>Close time <input id="fixClose" type="time" value="20:30"></label></div>
      <div class="subtitle">Times use the Pi's timezone. Optional TZ override below.</div>
    </div>

    <div id="solarBlock" class="grid2" style="display:none">
      <div><label>ZIP code <input id="zip" type="text" placeholder="e.g. 10001"></label></div>
      <div><label>Country (ISO-2) <input id="countryInput" type="text" value="US"></label></div>
      <div><label>Sunrise offset (min) <input id="sr" type="number" step="1" value="0"></label></div>
      <div><label>Sunset offset (min) <input id="ss" type="number" step="1" value="0"></label></div>
      <div class="subtitle">ZIP is preferred. The server geocodes ZIP to lat/lon offline on save.</div>
    </div>

    <div class="grid2">
      <div><label>Timezone (optional) <input id="tzInput" type="text" placeholder="America/New_York"></label></div>
      <div><label>Enforced open percent (0=uncapped) <input id="openPct" type="number" min="0" max="100" step="1" value="100"></label></div>
    </div>

    <div class="row" style="margin-top:8px">
      <button id="btnLoad" class="btn ghost" onclick="loadAuto()">Load</button>
      <button id="btnSave" class="btn primary" onclick="saveAuto()">Save</button>
      <button id="btnApply" class="btn neutral" onclick="applyAuto()">Apply Now</button>
    </div>

    <div id="autoOut" class="status-card" style="margin-top:10px">Use Load/Save/Apply.</div>

    <div class="card" style="margin-top:12px">
      <h3 class="title">Settings</h3>
      <div class="grid2">
        <div><label>Base URL <input id="baseUrl" type="text" placeholder="https://&lt;host&gt;.&lt;tailnet&gt;.ts.net"></label></div>
        <div><label>Bearer token (optional) <input id="bearer" type="password" placeholder="leave blank with Tailscale identity"></label></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn neutral" onclick="saveSettings()">Save Settings</button>
        <span class="subtitle">Saved in your browser only.</span>
      </div>
    </div>
  </section>

  <section id="page-diag" class="card" style="display:none">
    <h2 class="title">Diagnostics</h2>
    <div class="row">
      <button id="btnDiag" class="btn ghost" onclick="getDiag()">Refresh</button>
      <span class="subtitle">Shows last 100 log lines.</span>
    </div>
    <div id="diag" class="status-card" style="white-space: pre-wrap; margin-top:10px">No diag yet.</div>
  </section>
</main>

<footer class="sticky"><div class="tiny" id="hostLabel"></div></footer>

<script>
  // Settings storage
  const S = {
    get base(){ return localStorage.getItem('coop.base') || window.location.origin; },
    set base(v){ localStorage.setItem('coop.base', v); },
    get token(){ return localStorage.getItem('coop.bearer') || ''; },
    set token(v){ localStorage.setItem('coop.bearer', v); },
    get last(){ try{return JSON.parse(localStorage.getItem('coop.lastEvent')||'null')}catch(_){return null} },
    set last(o){ try{ localStorage.setItem('coop.lastEvent', JSON.stringify(o||null)); }catch(_){ } }
  };
  hostLabel.textContent = (new URL(S.base)).host;

  function saveSettings(){
    const b=baseUrl.value.trim();
    const t=bearer.value.trim();
    if(b) S.base=b;
    S.token=t;
    alert('Settings saved');
  }

  function headers(){
    const h={'Content-Type':'application/json'};
    const t=S.token;
    if (t) h['Authorization']='Bearer '+t;
    return h;
  }

  async function api(path, opts={}){
    const url=(localStorage.getItem('apiBase')||'')+path;
    const res=await fetch(url,{method:opts.method||'GET',headers:headers(),body:opts.body?JSON.stringify(opts.body):undefined,cache:'no-store'});
    const txt=await res.text(); let j={}; try{ j=txt?JSON.parse(txt):{} }catch(_){}
    if(!res.ok) throw new Error(j.detail||('HTTP '+res.status));
    return j;
  }

  // Tabs
  function showPage(id){
    document.querySelectorAll('nav.tabs a').forEach(a=>a.classList.remove('active'));
    document.querySelectorAll('main > section.card').forEach(s=>s.style.display='none');
    document.getElementById('tab-'+id).classList.add('active');
    document.getElementById('page-'+id).style.display='';
    if(id==='control'){ getStatus(); refreshSchedule(); }
    if(id==='config'){ loadAuto(); }
  }
  window.addEventListener('hashchange',()=>{ const h=(location.hash||'#control').slice(1); showPage(h); });
  showPage((location.hash||'#control').slice(1));

  // Status helpers
  function renderStatusBlock(opts){
    const connected = !!opts.connected;
    const evt = opts.last_event || {};
    const verb = evt.cmd ? (evt.cmd[0].toUpperCase()+evt.cmd.slice(1)) : 'n/a';
    const pct = (typeof evt.effective_percent==='number') ? ` ${evt.effective_percent}%` : '';
    const resStr = (evt.ok===true)?'Succeeded':(evt.ok===false)?'Failed':'Unknown';
    const latest = evt.cmd ? `Latest Action: ${verb}${pct} ${resStr}` : 'Latest Action: n/a';
    const sch = opts.schedule || {mode:'Unknown', openTime:'--:--', closeTime:'--:--'};
    const schedLines = `Schedule: ${sch.mode}`;
    sConnected.textContent = connected ? 'True' : 'False';
    sLast.textContent = latest;
    sSched.textContent = schedLines;
    sOpen.textContent = sch.openTime || '--:--';
    sClose.textContent = sch.closeTime || '--:--';
  }

  async function refreshSchedule(){
    try{
      const j = await api('/schedule/preview');
      capVal.textContent = (j.open_percent_cap>0)? `${j.open_percent_cap}%`:'none';
      renderStatusBlock({connected: (window.__lastConnected ?? false), last_event: window.__lastEvent || null,
        schedule:{mode: (j.mode||'fixed'), openTime:j.open_time, closeTime:j.close_time}});
    }catch(_){
      capVal.textContent = 'unknown';
    }
  }

  function setBusy(on){
    document.querySelectorAll('.btn').forEach(b=>b.classList.toggle('loading', on));
  }

  async function getStatus(){
    setBusy(true);
    try{
      const j = await api('/status');
      window.__lastConnected = !!j.connected;
      window.__lastEvent = j.last_event || window.__lastEvent || null;
      const badge = document.getElementById('apiBadge');
      if (badge) { badge.textContent = 'api: up'; badge.classList.remove('bad'); badge.classList.add('ok'); }
      renderStatusBlock({connected:j.connected, last_event: j.last_event||null, schedule:null});
    }catch(e){
      const badge = document.getElementById('apiBadge');
      if (badge) { badge.textContent = 'api: down'; badge.classList.remove('ok'); badge.classList.add('bad'); }
    }finally{
      setBusy(false);
      refreshSchedule();
    }
  }

  async function openTo(p){
    setBusy(true);
    try{
      const j = await api('/open?percent='+encodeURIComponent(p), {method:'POST'});
      window.__lastEvent = j.last_event || null;
      getStatus();
    }catch(e){
      alert('Open failed: '+e.message);
      getStatus();
    }finally{ setBusy(false); }
  }

  async function closeDoor(){
    setBusy(true);
    try{
      const j = await api('/close', {method:'POST'});
      window.__lastEvent = j.last_event || null;
      getStatus();
    }catch(e){
      alert('Close failed: '+e.message);
      getStatus();
    }finally{ setBusy(false); }
  }

  async function loadAuto(){
    setBusy(true);
    try{
      const j = await api('/automation');
      document.querySelector(`input[name="mode"][value="${j.mode||'fixed'}"]`).checked = true;
      document.getElementById('fixedBlock').style.display = (j.mode==='fixed')?'':'none';
      document.getElementById('solarBlock').style.display = (j.mode==='solar')?'':'none';
      if(j.fixed){ fixOpen.value=j.fixed.open||'07:00'; fixClose.value=j.fixed.close||'20:30'; }
      if(j.solar){ sr.value=j.solar.sunrise_offset_min||0; ss.value=j.solar.sunset_offset_min||0; }
      if(j.location){ zip.value=''; }
      if(j.timezone){ tzInput.value=j.timezone; }
      openPct.value = j.open_percent ?? 100;
      autoOut.textContent = 'Loaded current config.';
      refreshSchedule();
    }catch(e){
      autoOut.textContent = 'Load failed: '+e.message;
    }finally{ setBusy(false); }
  }

  async function saveAuto(){
    setBusy(true);
    try{
      const mode = document.querySelector('input[name="mode"]:checked')?.value || 'fixed';
      const payload = { mode, open_percent: parseInt(openPct.value||'100',10), timezone: tzInput.value||undefined };
      if (mode==='fixed'){
        payload.fixed = { open: fixOpen.value, close: fixClose.value };
      } else {
        payload.country = (countryInput.value||'US').trim();
        payload.zip = (zip.value||'').trim() || undefined;
        payload.solar = { sunrise_offset_min: parseInt(sr.value||'0',10), sunset_offset_min: parseInt(ss.value||'0',10) };
      }
      const j = await api('/automation', {method:'PUT', body:payload});
      autoOut.textContent = 'Saved.';
      refreshSchedule();
    }catch(e){
      autoOut.textContent = 'Save failed: '+e.message;
    }finally{ setBusy(false); }
  }

  async function applyAuto(){
    setBusy(true);
    try{
      const j = await api('/automation/apply', {method:'POST'});
      autoOut.textContent = 'Apply started.';
    }catch(e){
      autoOut.textContent = 'Apply failed: '+e.message;
    }finally{ setBusy(false); }
  }

  // ping banner
  (function(){
    const badge = document.getElementById('apiBadge');
    async function ping(){
      try{
        const res = await fetch((localStorage.getItem('apiBase')||'')+'/healthz', {cache:'no-store'});
        if (res.ok){ badge.textContent='api: up'; badge.classList.remove('bad'); badge.classList.add('ok'); }
        else { badge.textContent='api: warn'; badge.classList.remove('ok'); badge.classList.add('warn'); }
      }catch(_){
        badge.textContent='api: down'; badge.classList.remove('ok','warn'); badge.classList.add('bad');
      }
    }
    ping();
    setInterval(ping, 30000);
  })();
</script>
</body>
</html>
