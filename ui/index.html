<!doctype html>
<html lang="en">
<head>
<link rel="apple-touch-icon" sizes="180x180" href="/ui/apple-touch-icon.png?v=1761083686">  
<link rel="apple-touch-icon" sizes="167x167" href="/ui/apple-touch-icon-167.png?v=1761083686">  
<link rel="apple-touch-icon" sizes="152x152" href="/ui/apple-touch-icon-152.png?v=1761083686">  
<meta name="apple-mobile-web-app-title" content="CoopDoor">
  <meta charset="utf-8">
  <title>Coop Door</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#0b0b0c">
  <link rel="manifest" href="./manifest.webmanifest?v=1761083206">
  <style>
    :root {
      --bg:#0b0b0c; --bg-elev:#121316; --card:#0f1013; --border:#22252a;
      --fg:#e6e6e6; --muted:#9aa0a6; --brand:#4e5fff; --ok:#56d364; --warn:#f4bf4f; --bad:#ff7b72;
      --radius:12px; --shadow:0 6px 24px rgba(0,0,0,.35); --speed:.18s;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    header{position:sticky;top:0;z-index:50;padding:10px 14px;border-bottom:1px solid var(--border);
      background:#0d0e11cc;backdrop-filter:saturate(120%) blur(8px)}
    main{max-width:980px;margin:0 auto;padding:12px;display:grid;gap:12px}
    h1{margin:0;font-size:1.6rem;letter-spacing:.3px;color:#c7ccff}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grow{flex:1 1 auto}
    .pill{background:#1b1c20;border:1px solid var(--border);padding:6px 12px;border-radius:999px;font-size:.85rem}
    .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    nav.tabs{display:flex;gap:8px;border-bottom:1px solid var(--border)}
    nav.tabs a{padding:10px 12px;border-radius:10px 10px 0 0;color:var(--fg);text-decoration:none;border:1px solid transparent}
    nav.tabs a.active{border-color:var(--border);border-bottom-color:transparent;background:#15161a}
    .card{background:var(--bg-elev);border:1px solid var(--border);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow)}
    .title{margin:0 0 8px;font-size:.9rem;color:#c7ccff}
    .subtitle{color:var(--muted);font-size:.9rem;margin:.25rem 0 .75rem}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width:720px){.grid2,.grid3{grid-template-columns:1fr}}
    .btn{appearance:none;border:1px solid transparent;cursor:pointer;border-radius:12px;padding:10px 14px;font-weight:700;
      transition:transform var(--speed),background var(--speed),border-color var(--speed),opacity var(--speed);user-select:none;font-size:.9rem}
    .btn.primary{background:var(--brand);color:#fff}
    .btn.neutral{background:#1a1b1f;color:var(--fg);border-color:var(--border)}
    .btn.ghost{background:transparent;border-color:var(--border);color:var(--fg)}
    .btn.danger{background:#7d1f1f;color:#fff;border-color:#ff7b72}
    .btn:hover:not(:disabled){transform:translateY(-1px)}
    .btn:disabled{opacity:.55;cursor:default}
    .btn.loading{pointer-events:none;opacity:.85;position:relative}
    .btn.loading::after{content:"";width:18px;height:18px;border-radius:50%;border:2px solid #fff;border-right-color:transparent;position:absolute;right:12px;top:50%;transform:translateY(-50%);animation:spin .6s linear infinite}
    @keyframes spin{to{transform:translateY(-50%) rotate(360deg)}}
    .actions{display:grid;grid-template-columns:repeat(2, minmax(140px,1fr));gap:12px}
    .status-card{background:var(--card);border:1px dashed var(--border);padding:14px;border-radius:12px}
    .status-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px}
    .status-item{background:var(--card);padding:8px 10px;border-radius:8px;border-left:3px solid var(--brand)}
    .status-item.ok{border-left-color:var(--ok)}
    .status-item.bad{border-left-color:var(--bad)}
    .status-label{font-size:.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}
    .status-value{font-size:.95rem;font-weight:600;line-height:1.2}
    .kv{display:grid;grid-template-columns:130px 1fr;gap:6px 10px;font-family:ui-monospace, SFMono-Regular, Menlo, monospace}
    .dim{color:var(--muted)}
    footer.sticky{position:relative;left:0;right:0;bottom:0;padding:8px;text-align:center;background:transparent;margin-top:20px}
    .tiny{opacity:.65;font-size:.8rem}
    details.card summary{cursor:pointer;user-select:none}
    details.card summary:hover{color:var(--brand)}
    label{display:block;margin-bottom:4px;font-size:.9rem}
    input[type="text"],input[type="password"],input[type="number"],input[type="time"],select{
      width:100%;padding:8px 10px;background:var(--card);border:1px solid var(--border);
      border-radius:8px;color:var(--fg);font-size:.9rem;margin-top:4px}
    input[type="text"]:focus,input[type="password"]:focus,input[type="number"]:focus,input[type="time"]:focus,select:focus{
      outline:none;border-color:var(--brand)}
    input[type="checkbox"]{width:auto;margin-right:8px}
    .helper-text{display:block;margin-top:6px;font-size:.85rem;color:var(--muted);line-height:1.4}
    .helper-text strong{color:var(--fg)}
    .section-header{font-size:.95rem;color:var(--muted);margin:16px 0 8px;text-transform:uppercase;letter-spacing:.5px;font-weight:600}
    .alert{padding:12px;border-radius:8px;margin-bottom:12px;border-left:3px solid}
    .alert.info{background:#1a2332;border-left-color:#4e5fff;color:#b8c5ff}
    .alert.success{background:#1a2e22;border-left-color:#56d364;color:#aff5b4}
    .alert.warning{background:#332b1a;border-left-color:#f4bf4f;color:#f9e2af}
    .alert.error{background:#2e1a1a;border-left-color:#ff7b72;color:#ffb3b3}
    
    /* Diagnostics enhancements */
    .diag-controls{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
    .diag-controls .btn{padding:8px 14px;font-size:.85rem}
    .filter-badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:.75rem;margin-left:6px;font-weight:600}
    .filter-badge.error{background:#7d1f1f;color:#ffb3b3}
    .filter-badge.warn{background:#665722;color:#f9e2af}
    .filter-badge.info{background:#1f2f4d;color:#b8c5ff}
    #diag{white-space:pre-wrap;margin-top:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,monospace;font-size:13px;line-height:1.5}
    .log-line{padding:4px 0;border-bottom:1px solid #1a1b1f}
    .log-line:hover{background:#15161a}
    .log-line.error{color:#ffb3b3;background:#1f1212}
    .log-line.warn{color:#f9e2af;background:#1f1c12}
    .log-line.info{color:#b8c5ff}
    .log-timestamp{color:var(--muted);margin-right:8px}
    .log-level{display:inline-block;width:50px;font-weight:600}
    .search-box{flex:1;min-width:200px}
    
    /* Keyboard shortcuts hint */
    .kbd{display:inline-block;padding:2px 6px;background:var(--card);border:1px solid var(--border);border-radius:4px;font-size:.75rem;font-family:monospace;margin-left:4px}
    
    /* Loading state for status cards */
    .status-item.loading{opacity:.6;position:relative}
    .status-item.loading::after{content:"";position:absolute;top:50%;right:10px;width:16px;height:16px;border:2px solid var(--brand);border-right-color:transparent;border-radius:50%;animation:spin .6s linear infinite}
    
    /* Pulse animation for active state */
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    .pulsing{animation:pulse 2s ease-in-out infinite}
    
    /* Better number input styling */
    input[type="number"]{-moz-appearance:textfield}
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
    
    /* Info icon tooltip */
    .info-icon{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:16px;
      height:16px;
      border-radius:50%;
      background:var(--border);
      color:var(--muted);
      font-size:11px;
      font-weight:bold;
      cursor:help;
      margin-left:6px;
      transition:all .2s;
      user-select:none;
    }
    .info-icon:hover{
      background:var(--brand);
      color:#fff;
      transform:scale(1.1);
    }
    .info-tooltip{
      display:none;
      position:absolute;
      background:var(--bg-elev);
      border:1px solid var(--border);
      border-radius:8px;
      padding:10px 12px;
      font-size:.85rem;
      color:var(--fg);
      line-height:1.4;
      max-width:280px;
      z-index:100;
      box-shadow:0 4px 12px rgba(0,0,0,.4);
      margin-top:4px;
    }
    .info-tooltip.show{display:block}
    .info-tooltip strong{color:var(--brand)}
    .label-with-info{display:flex;align-items:center}
  </style>
  <script defer src="./hardening.js"></script>

  <script>
  /* API BOOT SHIM */
  (function(){
    try {
      var b = (localStorage.getItem('apiBase') || '').trim();
      if (!b || !/^https?:\/\//i.test(b)) {
        localStorage.setItem('apiBase', window.location.origin);
      }
    } catch (e) {}
  })();
  </script>

</head>
<body>
<header>
  <div class="row">
    <h1 class="grow">Coop Door</h1>
    <span id="apiBadge" class="pill bad">api: down</span>
    <span id="doorBadge" class="pill warn">door: idle</span>
  </div>
</header>

<main>
  <nav class="tabs">
    <a href="#control" id="tab-control" class="active">Control / Status</a>
    <a href="#config"  id="tab-config">Config</a>
    <a href="#diag"    id="tab-diag">Diagnostics</a>
  </nav>

  <!-- CONTROL / STATUS TAB -->
  <section id="page-control" class="card">
    <div class="row" style="margin-bottom:8px">
      <h2 class="title" style="margin:0;font-size:.9rem">Status</h2>
      <span class="tiny" style="margin-left:auto;color:var(--muted)">v1.0.0</span>
    </div>
    
    <div class="status-grid" style="grid-template-columns:repeat(auto-fit,minmax(140px,1fr))">
      <div class="status-item" id="statusConnection">
        <div class="status-label">Connection</div>
        <div class="status-value" id="statusConnValue">Checking...</div>
      </div>
      <div class="status-item">
        <div class="status-label">Door Position</div>
        <div class="status-value" id="statusDoorPos">Unknown</div>
      </div>
      <div class="status-item">
        <div class="status-label">Mode</div>
        <div class="status-value" id="statusMode">--</div>
      </div>
      <div class="status-item">
        <div class="status-label">Next Scheduled</div>
        <div class="status-value" id="statusNextSched">Not set</div>
      </div>
      <div class="status-item">
        <div class="status-label">Opens At</div>
        <div class="status-value" id="statusOpenTime">--:--</div>
      </div>
      <div class="status-item">
        <div class="status-label">Closes At</div>
        <div class="status-value" id="statusCloseTime">--:--</div>
      </div>
      <div class="status-item">
        <div class="status-label">Last Action</div>
        <div class="status-value" id="statusLastAction">None</div>
      </div>
      <div class="status-item" id="statusLastResult">
        <div class="status-label">Result</div>
        <div class="status-value" id="statusResult">--</div>
      </div>
    </div>

    <h2 class="title" style="margin-top:16px;margin-bottom:8px">Manual Control</h2>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
      <button class="btn primary" onclick="openTo(25)">25%</button>
      <button class="btn primary" onclick="openTo(50)">50%</button>
      <button class="btn primary" onclick="openTo(75)">75%</button>
      <button class="btn primary" onclick="openTo(100)">100%</button>
    </div>
    
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;align-items:center">
      <input type="number" id="customPercent" min="0" max="100" value="50" step="1" placeholder="Custom %" style="padding:10px">
      <button id="btnCustomOpen" class="btn primary" onclick="openToCustom()">Open</button>
    </div>
    
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
      <button id="btnClose" class="btn neutral" onclick="closeDoor()">Close</button>
      <button id="btnStatus" class="btn ghost" onclick="getStatus()">Refresh</button>
    </div>
  </section>

  <!-- CONFIG TAB -->
  <section id="page-config" class="card" style="display:none">
    <div id="configAlert"></div>

    <h2 class="title">Schedule Mode</h2>
    <div class="row" style="margin-bottom:12px">
      <label><input type="radio" name="mode" value="fixed" checked> Fixed Times</label>
      <label><input type="radio" name="mode" value="solar"> Sunrise / Sunset</label>
    </div>

    <div id="fixedBlock" class="grid2">
      <div><label>Open time <input id="fixOpen" type="time" value="07:00"></label></div>
      <div><label>Close time <input id="fixClose" type="time" value="20:30"></label></div>
    </div>

    <div id="solarBlock" class="grid2" style="display:none">
      <div><label>ZIP code <input id="zip" type="text" placeholder="33411"></label></div>
      <div><label>Country (ISO-2) <input id="countryInput" type="text" value="US"></label></div>
    </div>

    <div id="solarOffsets" style="display:none;margin-top:12px">
      <h3 class="section-header">Time Offsets (minutes)</h3>
      <div class="alert info" style="margin-bottom:10px;padding:8px 12px">
        <strong>Positive (+)</strong> = delay (e.g., +30 opens 30 min AFTER sunrise)<br>
        <strong>Negative (-)</strong> = advance (e.g., -30 closes 30 min BEFORE sunset)
      </div>
      <div class="grid2">
        <div><label>Sunrise offset <input id="sr" type="number" step="1" value="0"></label></div>
        <div><label>Sunset offset <input id="ss" type="number" step="1" value="0"></label></div>
      </div>
    </div>

    <div style="margin-top:16px">
      <div class="label-with-info">
        <label style="margin:0">Maximum Door Opening (%)</label>
        <span class="info-icon" onclick="toggleInfo(event, 'info-maxopen')">i</span>
      </div>
      <input id="openPct" type="number" min="0" max="100" step="1" value="100">
      <div id="info-maxopen" class="info-tooltip">
        Limits how far the door opens. Set to 0 for no limit, or lower for smaller chickens (e.g., 75% for bantams).
      </div>
    </div>

    <details class="card" style="margin-top:20px" open>
      <summary class="title">Advanced Settings</summary>
      
      <div class="alert info" style="margin-top:12px">
        ℹ️ Clicking "Save & Apply" will automatically restart the API to apply these settings.
      </div>

      <div class="grid2" style="margin-top:12px">
        <div>
          <div class="label-with-info">
            <label style="margin:0">Device MAC Address</label>
            <span class="info-icon" onclick="toggleInfo(event, 'info-mac')">i</span>
          </div>
          <input id="bleMac" type="text" placeholder="00:80:E1:22:EE:F2">
          <div id="info-mac" class="info-tooltip">
            Bluetooth address of your door opener. Find it with: <code>sudo hcitool lescan</code>
          </div>
        </div>
        <div>
          <div class="label-with-info">
            <label style="margin:0">Bluetooth Adapter</label>
            <span class="info-icon" onclick="toggleInfo(event, 'info-adapter')">i</span>
          </div>
          <input id="bleAdapter" type="text" value="hci0">
          <div id="info-adapter" class="info-tooltip">
            Usually "hci0" - only change if using multiple Bluetooth adapters
          </div>
        </div>
        <div>
          <div class="label-with-info">
            <label style="margin:0">Connection Timeout (s)</label>
            <span class="info-icon" onclick="toggleInfo(event, 'info-timeout')">i</span>
          </div>
          <input id="connectTimeout" type="number" min="5" max="60" value="15">
          <div id="info-timeout" class="info-tooltip">
            How long to wait for BLE connection. <strong>Increase</strong> if device is far away or slow to respond.
          </div>
        </div>
        <div>
          <div class="label-with-info">
            <label style="margin:0">Base Pulses (100% open)</label>
            <span class="info-icon" onclick="toggleInfo(event, 'info-pulses')">i</span>
          </div>
          <input id="basePulses" type="number" min="1" max="50" value="14">
          <div id="info-pulses" class="info-tooltip">
            Number of pulses for full opening. Default: 14. Adjust if door doesn't fully open or close.
          </div>
        </div>
        <div>
          <div class="label-with-info">
            <label style="margin:0">Pulse Interval (s)</label>
            <span class="info-icon" onclick="toggleInfo(event, 'info-interval')">i</span>
          </div>
          <input id="pulseInterval" type="number" min="0.5" max="5" step="0.1" value="2.0">
          <div id="info-interval" class="info-tooltip">
            Delay between pulses. <strong>Increase</strong> if door motor needs more time between commands.
          </div>
        </div>
        <div>
          <div class="label-with-info">
            <label style="margin:0">Min Pause After Action (s)</label>
            <span class="info-icon" onclick="toggleInfo(event, 'info-pause')">i</span>
          </div>
          <input id="minPause" type="number" min="0" max="10" step="0.5" value="1.0">
          <div id="info-pause" class="info-tooltip">
            Cooldown period after operations. Prevents rapid repeated commands.
          </div>
        </div>
        <div>
          <div class="label-with-info">
            <label style="margin:0">Retry Attempts</label>
            <span class="info-icon" onclick="toggleInfo(event, 'info-retry')">i</span>
          </div>
          <input id="retryAttempts" type="number" min="0" max="10" value="3">
          <div id="info-retry" class="info-tooltip">
            How many times to retry failed connections. Default: 3
          </div>
        </div>
        <div>
          <div class="label-with-info">
            <label style="margin:0">Retry Delay (ms)</label>
            <span class="info-icon" onclick="toggleInfo(event, 'info-delay')">i</span>
          </div>
          <input id="retryDelay" type="number" min="100" max="5000" step="100" value="1000">
          <div id="info-delay" class="info-tooltip">
            Wait time between retries. Increases with each attempt (exponential backoff).
          </div>
        </div>
      </div>

      <div style="margin-top:16px">
        <div style="display:flex;align-items:center;gap:8px">
          <label style="margin:0;cursor:pointer">
            <input type="checkbox" id="homeBeforeOpen">
            Close door before opening (calibration)
          </label>
          <span class="info-icon" onclick="toggleInfo(event, 'info-home')">i</span>
        </div>
        <div id="info-home" class="info-tooltip">
          Fully closes door before each open command. Ensures consistent starting position but adds time.
        </div>
      </div>
    </details>

    <div class="row" style="margin-top:16px;gap:10px">
      <button class="btn primary" onclick="saveAndApply()" style="flex:1">Save & Apply</button>
      <button class="btn ghost" onclick="loadConfig()">Reset</button>
    </div>

    <div class="card" style="margin-top:16px">
      <h3 class="title">API Connection</h3>
      <div class="grid2">
        <div><label>Base URL <input id="baseUrl" type="text" placeholder="https://host.tailnet.ts.net"></label></div>
        <div><label>Bearer Token (optional) <input id="bearer" type="password" placeholder="leave blank with Tailscale"></label></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn neutral" onclick="saveSettings()">Save Connection Settings</button>
        <span class="subtitle">Saved in your browser only.</span>
      </div>
    </div>
  </section>

  <!-- DIAGNOSTICS TAB -->
  <section id="page-diag" class="card" style="display:none">
    <h2 class="title">Diagnostics</h2>
    
    <div class="diag-controls">
      <button class="btn ghost" onclick="getDiag()">Refresh</button>
      <button class="btn ghost" onclick="clearDiagDisplay()">Clear</button>
      <button class="btn ghost" onclick="toggleAutoRefresh()">
        <span id="autoRefreshLabel">Auto-Refresh: OFF</span>
      </button>
      <input type="text" id="logSearch" class="search-box" placeholder="Search logs..." oninput="filterLogs()">
      <select id="logLevelFilter" onchange="filterLogs()" style="width:auto">
        <option value="all">All Levels</option>
        <option value="error">Errors</option>
        <option value="warn">Warnings</option>
        <option value="info">Info</option>
      </select>
      <button class="btn ghost" onclick="exportLogs()">Export</button>
    </div>

    <div class="status-card">
      <div class="row" style="margin-bottom:8px">
        <strong>Connection:</strong> <span id="diagConn">Unknown</span>
        <span id="diagFilters"></span>
      </div>
      <div id="diagStats" style="font-size:.85rem;color:var(--muted)"></div>
    </div>

    <div id="diag" class="status-card">No diagnostics loaded yet. Click Refresh.</div>
  </section>
</main>

<footer class="sticky">
  <div class="tiny" id="hostLabel"></div>
</footer>

<script>
  // #reset support
  (function(){
    if (location.hash === '#reset') {
      try {
        ['apiBase','apiToken','coop.base','coop.bearer','coop.lastEvent'].forEach(k=>localStorage.removeItem(k));
      } catch(e) {}
      location.replace('/ui/?v=' + Date.now());
    }
  })();

  // Tabs
  function showPage(id){
    document.querySelectorAll('nav.tabs a').forEach(a=>a.classList.remove('active'));
    document.querySelectorAll('main > section.card').forEach(s=>s.style.display='none');
    document.getElementById('tab-'+id).classList.add('active');
    document.getElementById('page-'+id).style.display='';
    if(id==='control'){ getStatus(); refreshSchedule(); }
    if(id==='config'){ loadConfig(); }
    if(id==='diag'){ getDiag(); }
  }
  window.addEventListener('hashchange',()=>{ const h=(location.hash||'#control').slice(1); showPage(h); });
  showPage((location.hash||'#control').slice(1));

  // Settings storage
  const S = {
    get base(){ return (localStorage.getItem('apiBase') || '').trim(); },
    set base(v){ localStorage.setItem('apiBase', v); },
    get token(){ return (localStorage.getItem('apiToken') || '').trim(); },
    set token(v){ localStorage.setItem('apiToken', v); },
    get last(){ try{return JSON.parse(localStorage.getItem('coop.lastEvent')||'null')}catch(_){return null} },
    set last(o){ try{ localStorage.setItem('coop.lastEvent', JSON.stringify(o||null)); }catch(_){ } }
  };
  hostLabel.textContent = (S.base || window.location.origin);

  function headers(){ const h={'Content-Type':'application/json'}; if(S.token) h['Authorization']='Bearer '+S.token; return h; }

  // Ping loop
  (function(){
    async function ping(){
      const url = (S.base || '') + '/healthz';
      try {
        const res = await fetch(url, {cache:'no-store'});
        const ok = res && res.ok;
        const badge = document.getElementById('apiBadge');
        badge.textContent = ok ? 'api: up' : 'api: down';
        badge.classList.toggle('ok',  !!ok);
        badge.classList.toggle('bad', !ok);
      } catch (e) {
        const badge = document.getElementById('apiBadge');
        badge.textContent = 'api: down';
        badge.classList.remove('ok'); badge.classList.add('bad');
      }
    }
    ping(); setInterval(ping, 30000);
  })();

  // Fetch with timeout + retry
  async function fetchWithHedge(url, opts={}, timeoutMs=20000){
    const doOnce = () => new Promise((resolve,reject)=>{
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), timeoutMs);
      fetch(url, {...opts, signal: ctrl.signal}).then(r=>{clearTimeout(t); resolve(r)}).catch(e=>{clearTimeout(t); reject(e)});
    });
    try { return await doOnce(); } catch(_){ return await doOnce(); }
  }

  async function api(path, opts={}){
    const url = (S.base || '') + path;
    const res = await fetchWithHedge(url, {
      method: opts.method || 'GET',
      headers: headers(),
      body: opts.body ? JSON.stringify(opts.body) : undefined,
      cache: 'no-store'
    }, opts.timeoutMs || 20000);
    const text = await res.text();
    let json = {};
    if (text) { try { json = JSON.parse(text); } catch(_) {} }
    if (!res.ok) { const msg = (json && (json.detail || json.stderr)) || ('HTTP '+res.status); throw new Error(msg); }
    return json;
  }

  function fmt(dtISO){
    if(!dtISO) return {time:'--:--:--', date:'--/--/--'};
    const d=new Date(dtISO);
    return {time:d.toLocaleTimeString([], {hour12:false}), date:d.toLocaleDateString()};
  }

  function showAlert(type, message){
    const alert = document.getElementById('configAlert');
    alert.innerHTML = `<div class="alert ${type}">${message}</div>`;
    setTimeout(() => alert.innerHTML = '', 5000);
  }

  // ===== CONTROL / STATUS =====
  
  function renderStatus(e){
    // Connection
    const connEl = document.getElementById('statusConnection');
    const connValue = document.getElementById('statusConnValue');
    if (e && e.connected) {
      connValue.textContent = 'Connected';
      connEl.classList.add('ok');
      connEl.classList.remove('bad');
    } else {
      connValue.textContent = 'Disconnected';
      connEl.classList.add('bad');
      connEl.classList.remove('ok');
    }

    // Door position - ALWAYS prioritize door_state
    const doorPosEl = document.getElementById('statusDoorPos');
    const doorState = e && e.door_state;
    
    // Only update if we have door_state data
    if (doorState && typeof doorState.position_percent === 'number') {
      doorPosEl.textContent = doorState.position_percent + '%';
      // Store this so we don't lose it
      window._lastKnownPosition = doorState.position_percent;
    } else if (window._lastKnownPosition !== undefined) {
      // Use last known position if we don't have new door state
      doorPosEl.textContent = window._lastKnownPosition + '%';
    } else {
      // Fall back to last action only if we have nothing else
      const lastAction = (e && e.last_action) || S.last;
      if (lastAction && lastAction.cmd === 'open' && typeof lastAction.requested_percent === 'number') {
        doorPosEl.textContent = lastAction.requested_percent + '%';
        window._lastKnownPosition = lastAction.requested_percent;
      } else if (lastAction && lastAction.cmd === 'close') {
        doorPosEl.textContent = '0%';
        window._lastKnownPosition = 0;
      } else {
        doorPosEl.textContent = 'Unknown';
      }
    }

    // Last action and result
    const le = (e && e.last_action) || S.last;
    const lastActionEl = document.getElementById('statusLastAction');
    const resultEl = document.getElementById('statusResult');
    const resultCard = document.getElementById('statusLastResult');
    
    if (le && le.cmd) {
      const verb = le.cmd.charAt(0).toUpperCase() + le.cmd.slice(1);
      const pct = (le.cmd === 'open' && typeof le.requested_percent === 'number') ? (' ' + le.requested_percent + '%') : '';
      const src = le.source ? ' (' + (le.source === 'scheduled' ? 'scheduled' : 'manual') + ')' : '';
      lastActionEl.innerHTML = `${verb}${pct}${src}`;
      
      // Show result
      if (le.ok === true) {
        resultEl.textContent = 'Succeeded';
        resultEl.style.color = 'var(--ok)';
        resultCard.classList.add('ok');
        resultCard.classList.remove('bad');
      } else if (le.ok === false) {
        resultEl.textContent = 'Failed';
        resultEl.style.color = 'var(--bad)';
        resultCard.classList.add('bad');
        resultCard.classList.remove('ok');
      } else {
        resultEl.textContent = 'Pending';
        resultEl.style.color = 'var(--warn)';
        resultCard.classList.remove('ok', 'bad');
      }
    } else {
      lastActionEl.textContent = 'None';
      resultEl.textContent = '--';
      resultCard.classList.remove('ok', 'bad');
    }
  }

  async function getStatus(){
    try {
      const j = await api('/status');
      if (j.last_action) S.last = j.last_action;
      renderStatus(j);
    } catch(e){
      renderStatus({connected:false, last_action:S.last});
    }
  }

  async function refreshSchedule(){
    try{
      const j = await api('/schedule/preview');
      
      // Update mode
      document.getElementById('statusMode').textContent = (j.mode || 'Unknown');
      
      // Update times
      document.getElementById('statusOpenTime').textContent = j.open_time || '--:--';
      document.getElementById('statusCloseTime').textContent = j.close_time || '--:--';
      
      // Update next scheduled - handle various formats
      const nextEl = document.getElementById('statusNextSched');
      
      if (j.next_scheduled) {
        try {
          const d = new Date(j.next_scheduled);
          
          if (!isNaN(d.getTime())) {
            // Show just the time if it's today, otherwise show date + time
            const now = new Date();
            const isToday = d.toDateString() === now.toDateString();
            
            if (isToday) {
              nextEl.textContent = d.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            } else {
              nextEl.textContent = d.toLocaleDateString([], {month: 'short', day: 'numeric'}) + ' ' + 
                                   d.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            }
          } else {
            nextEl.textContent = 'Not set';
          }
        } catch(e) {
          nextEl.textContent = 'Not set';
        }
      } else {
        nextEl.textContent = 'Not set';
      }
    }catch(e){
      document.getElementById('statusMode').textContent = 'Unknown';
      document.getElementById('statusOpenTime').textContent = '--:--';
      document.getElementById('statusCloseTime').textContent = '--:--';
      document.getElementById('statusNextSched').textContent = 'Not set';
    }
  }

  function showOptimisticState(cmd, pct){
    const optimistic = {
      cmd: cmd,
      requested_percent: pct,
      ok: null,
      at: new Date().toISOString(),
      source: 'api'
    };
    S.last = optimistic;
    
    const verb = cmd.charAt(0).toUpperCase() + cmd.slice(1);
    const pctStr = (cmd === 'open' && pct) ? (' ' + pct + '%') : '';
    const src = ' (manual)';
    
    // Update last action (without pending indicator)
    document.getElementById('statusLastAction').innerHTML = `${verb}${pctStr}${src}`;
    
    // Show "Pending" in Result card
    const resultEl = document.getElementById('statusResult');
    const resultCard = document.getElementById('statusLastResult');
    resultEl.textContent = 'Pending';
    resultEl.style.color = 'var(--warn)';
    resultCard.classList.remove('ok', 'bad');
    
    // Don't update door position optimistically - wait for door_state from API
  }

  function setLoading(el, on){ el.classList.toggle('loading', !!on); el.disabled = !!on; }

  async function openTo(pct){
    const btn = event.target;
    setLoading(btn, true);
    showOptimisticState('open', pct);
    
    try {
      const result = await api('/open?percent=' + encodeURIComponent(pct), {method:'POST', timeoutMs:30000});
      if (result.last_event) {
        S.last = result.last_event;
        renderStatus({connected:true, last_event:result.last_event, door_state:result.door_state});
      }
    } catch(e) {
      const lastActionEl = document.getElementById('statusLastAction');
      lastActionEl.innerHTML += ' <span style="color:var(--warn)">(error)</span>';
    }
    
    setLoading(btn, false);
    setTimeout(getStatus, 2000);
  }
  
  async function openToCustom() {
    const value = parseInt(document.getElementById('customPercent').value);
    if (isNaN(value) || value < 0 || value > 100) {
      alert('Please enter a valid percentage (0-100)');
      return;
    }
    
    const btn = document.getElementById('btnCustomOpen');
    setLoading(btn, true);
    showOptimisticState('open', value);
    
    try {
      const result = await api('/open?percent=' + encodeURIComponent(value), {method:'POST', timeoutMs:30000});
      if (result.last_event) {
        S.last = result.last_event;
        renderStatus({connected:true, last_event:result.last_event, door_state:result.door_state});
      }
    } catch(e) {
      const lastActionEl = document.getElementById('statusLastAction');
      lastActionEl.innerHTML += ' <span style="color:var(--warn)">(error)</span>';
    }
    
    setLoading(btn, false);
    setTimeout(getStatus, 2000);
  }

  async function closeDoor(){
    const btn = document.getElementById('btnClose');
    setLoading(btn, true);
    showOptimisticState('close', 0);
    
    try {
      const result = await api('/close', {method:'POST', timeoutMs:30000});
      if (result.last_event) {
        S.last = result.last_event;
        renderStatus({connected:true, last_event:result.last_event, door_state:result.door_state});
      }
    } catch(e) {
      const lastActionEl = document.getElementById('statusLastAction');
      lastActionEl.innerHTML += ' <span style="color:var(--warn)">(error)</span>';
    }
    
    setLoading(btn, false);
    setTimeout(getStatus, 2000);
  }

  // ===== CONFIG =====
  
  let currentConfig = {};
  
  async function loadConfig(){
    try{
      const cfg = await api('/config');
      currentConfig = cfg;
      
      const auto = cfg.automation || {};
      const ble = cfg.ble || {};
      
      // Mode
      const isSolar = auto.mode === 'solar';
      document.querySelector('input[name="mode"][value="' + (isSolar ? 'solar' : 'fixed') + '"]').checked = true;
      toggleModeFields();
      
      // Fixed times
      if (auto.fixed){ 
        fixOpen.value = auto.fixed.open; 
        fixClose.value = auto.fixed.close; 
      }
      
      // Solar
      if (auto.solar){ 
        sr.value = auto.solar.sunrise_offset_min||0; 
        ss.value = auto.solar.sunset_offset_min||0; 
      }
      if (auto.location){ 
        zip.value = auto.location.zip || '';
        countryInput.value = auto.location.country || 'US';
      }
      
      openPct.value = auto.open_percent ?? 100;
      
      // BLE
      bleAdapter.value = ble.adapter || 'hci0';
      bleMac.value = ble.mac || '';
      connectTimeout.value = ble.connect_timeout || 15;
      basePulses.value = ble.base_pulses || 14;
      pulseInterval.value = ble.pulse_interval || 2.0;
      minPause.value = ble.min_pause_after_action || 1.0;
      homeBeforeOpen.checked = ble.home_before_open || false;
      retryAttempts.value = ble.retry_attempts || 3;
      retryDelay.value = ble.retry_initial_delay_ms || 1000;
      
      showAlert('success', 'Config loaded successfully');
      await refreshSchedule();
    }catch(e){ 
      showAlert('error', 'Load failed: ' + e.message);
    }
  }

  async function saveAndApply(){
    if (!confirm('Save configuration and restart API? The page will reload.')) return;
    
    const mode = document.querySelector('input[name="mode"]:checked').value;
    
    const payload = {
      automation: {
        mode: mode,
        open_percent: parseInt(openPct.value,10) || 0
      },
      ble: {
        adapter: bleAdapter.value.trim(),
        mac: bleMac.value.trim(),
        connect_timeout: parseInt(connectTimeout.value,10) || 15,
        base_pulses: parseInt(basePulses.value,10) || 14,
        pulse_interval: parseFloat(pulseInterval.value) || 2.0,
        min_pause_after_action: parseFloat(minPause.value) || 1.0,
        home_before_open: homeBeforeOpen.checked,
        retry_attempts: parseInt(retryAttempts.value,10) || 3,
        retry_initial_delay_ms: parseInt(retryDelay.value,10) || 1000
      }
    };
    
    if (mode==='fixed'){
      payload.automation.fixed = { 
        open: fixOpen.value, 
        close: fixClose.value 
      };
    } else {
      const country = (countryInput.value||'US').trim().toUpperCase();
      const zipVal = (zip.value||'').trim();
      if (zipVal) {
        payload.automation.zip = zipVal;
        payload.automation.country = country;
      }
      payload.automation.solar = { 
        sunrise_offset_min: parseInt(sr.value||'0',10), 
        sunset_offset_min: parseInt(ss.value||'0',10) 
      };
    }
    
    try{
      // Save config
      await api('/config', {method:'PUT', body: payload});
      showAlert('info', 'Config saved. Applying schedule and restarting API...');
      
      // Apply schedule
      await api('/automation/apply', {method:'POST'});
      
      // Restart API
      await api('/restart', {method:'POST'});
      
      showAlert('success', 'Configuration applied. Reloading in 3 seconds...');
      setTimeout(() => window.location.reload(), 3000);
    }catch(e){ 
      showAlert('error', 'Save/Apply failed: ' + e.message);
    }
  }

  function toggleModeFields() {
    const mode = document.querySelector('input[name="mode"]:checked').value;
    const isSolar = mode === 'solar';
    
    solarBlock.style.display = isSolar ? '' : 'none';
    fixedBlock.style.display = isSolar ? 'none' : '';
    solarOffsets.style.display = isSolar ? '' : 'none';
  }

  document.querySelectorAll('input[name="mode"]').forEach(r=>{
    r.addEventListener('change', toggleModeFields);
  });

  // ===== DIAGNOSTICS =====
  
  let autoRefreshInterval = null;
  let allLogLines = [];
  
  async function getDiag(){
    const box = document.getElementById('diag');
    try {
      const res = await fetch((S.base || '') + '/diag', { 
        headers: headers(),
        cache:'no-store' 
      });
      const text = await res.text();
      if (!res.ok) {
        box.innerHTML = '<div class="log-line error">Error ' + res.status + ': ' + (text || '(no body)') + '</div>';
        return;
      }
      
      let j;
      try {
        j = JSON.parse(text||'{}');
      } catch(parseErr) {
        box.innerHTML = '<div class="log-line error">Failed to parse JSON response</div>';
        return;
      }
      
      // Update connection status
      document.getElementById('diagConn').innerHTML = j.connected === true 
        ? '<span class="ok">Connected</span>' 
        : '<span class="bad">Disconnected</span>';
      
      // Parse and display logs
      allLogLines = [];
      
      // Check if logs exist and is an array
      if (j.logs && Array.isArray(j.logs) && j.logs.length > 0) {
        allLogLines = j.logs.map(e => {
          // Handle both object format {ts, msg} and string format
          if (typeof e === 'string') {
            return {
              ts: new Date().toISOString().substring(11, 19),
              msg: e,
              level: detectLogLevel(e)
            };
          } else {
            return {
              ts: e.ts || e.timestamp || '',
              msg: e.msg || e.message || String(e),
              level: detectLogLevel(e.msg || e.message || String(e))
            };
          }
        });
      } else if (j.stderr) {
        // If stderr field exists, parse it as log lines
        const lines = j.stderr.split('\n').filter(l => l.trim());
        allLogLines = lines.map(line => ({
          ts: '',
          msg: line,
          level: detectLogLevel(line)
        }));
      } else if (j.stdout) {
        // If stdout field exists, parse it as log lines
        const lines = j.stdout.split('\n').filter(l => l.trim());
        allLogLines = lines.map(line => ({
          ts: '',
          msg: line,
          level: detectLogLevel(line)
        }));
      }
      
      // Show stats
      if (allLogLines.length > 0) {
        const errorCount = allLogLines.filter(l => l.level === 'error').length;
        const warnCount = allLogLines.filter(l => l.level === 'warn').length;
        const infoCount = allLogLines.filter(l => l.level === 'info').length;
        
        document.getElementById('diagStats').innerHTML = 
          `Total: ${allLogLines.length} | ` +
          `<span class="bad">Errors: ${errorCount}</span> | ` +
          `<span class="warn">Warnings: ${warnCount}</span> | ` +
          `Info: ${infoCount}`;
      } else {
        document.getElementById('diagStats').innerHTML = 'No logs available';
      }
      
      filterLogs();
      
    } catch (e) {
      box.innerHTML = '<div class="log-line error">Fetch failed: ' + (e && e.message || e) + '</div>';
    }
  }
  
  function detectLogLevel(msg) {
    const lower = msg.toLowerCase();
    if (lower.includes('error') || lower.includes('failed') || lower.includes('exception')) return 'error';
    if (lower.includes('warn') || lower.includes('warning')) return 'warn';
    if (lower.includes('info') || lower.includes('success')) return 'info';
    return 'info';
  }
  
  function filterLogs() {
    const searchTerm = document.getElementById('logSearch').value.toLowerCase();
    const levelFilter = document.getElementById('logLevelFilter').value;
    
    let filtered = allLogLines;
    
    // Filter by level
    if (levelFilter !== 'all') {
      filtered = filtered.filter(l => l.level === levelFilter);
    }
    
    // Filter by search term
    if (searchTerm) {
      filtered = filtered.filter(l => 
        l.msg.toLowerCase().includes(searchTerm) || 
        l.ts.toLowerCase().includes(searchTerm)
      );
    }
    
    // Render
    const box = document.getElementById('diag');
    if (filtered.length === 0) {
      box.innerHTML = '<div class="log-line">No logs match your filters.</div>';
      return;
    }
    
    const html = filtered.map(l => {
      return `<div class="log-line ${l.level}">` +
        `<span class="log-timestamp">[${l.ts}]</span>` +
        `<span class="log-level ${l.level}">${l.level.toUpperCase()}</span> ` +
        escapeHtml(l.msg) +
        `</div>`;
    }).join('');
    
    box.innerHTML = html;
    
    // Update filter badges
    let badges = '';
    if (levelFilter !== 'all') {
      badges += `<span class="filter-badge ${levelFilter}">${levelFilter}</span>`;
    }
    if (searchTerm) {
      badges += `<span class="filter-badge info">search: "${searchTerm}"</span>`;
    }
    document.getElementById('diagFilters').innerHTML = badges;
  }
  
  function clearDiagDisplay() {
    document.getElementById('diag').innerHTML = '<div class="log-line">Diagnostics cleared. Click Refresh to reload.</div>';
    allLogLines = [];
    document.getElementById('diagStats').innerHTML = '';
    document.getElementById('diagFilters').innerHTML = '';
  }
  
  function toggleAutoRefresh() {
    if (autoRefreshInterval) {
      clearInterval(autoRefreshInterval);
      autoRefreshInterval = null;
      document.getElementById('autoRefreshLabel').textContent = 'Auto-Refresh: OFF';
    } else {
      autoRefreshInterval = setInterval(getDiag, 5000);
      document.getElementById('autoRefreshLabel').textContent = 'Auto-Refresh: ON';
      getDiag(); // Immediate refresh
    }
  }
  
  function exportLogs() {
    const text = allLogLines.map(l => `[${l.ts}] ${l.level.toUpperCase()} ${l.msg}`).join('\n');
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `coopdoor-logs-${new Date().toISOString()}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  }
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // Info tooltip toggle
  function toggleInfo(event, tooltipId) {
    event.stopPropagation();
    const tooltip = document.getElementById(tooltipId);
    const wasVisible = tooltip.classList.contains('show');
    
    // Hide all tooltips
    document.querySelectorAll('.info-tooltip').forEach(t => t.classList.remove('show'));
    
    // Toggle this one
    if (!wasVisible) {
      tooltip.classList.add('show');
      
      // Position tooltip
      const icon = event.target;
      const rect = icon.getBoundingClientRect();
      tooltip.style.position = 'absolute';
      tooltip.style.left = (rect.left - 10) + 'px';
      tooltip.style.top = (rect.bottom + 4) + 'px';
    }
  }
  
  // Close tooltips when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.classList.contains('info-icon')) {
      document.querySelectorAll('.info-tooltip').forEach(t => t.classList.remove('show'));
    }
  });

  // Initial load
  getStatus(); 
  refreshSchedule();
</script>
</body>
</html>
